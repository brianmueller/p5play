<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png">
  <title>Tag</title>
  <style>
    html,
    body {
      background-color: black;
      margin: 0;
      padding: 0;
      overscroll-behavior: none;
    }

    #namePrompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 20px;
      text-align: center;
    }
  </style>
</head>

<body>
  <main></main>

  <div id="namePrompt">
    <label for="playerName">Enter your name:</label>
    <input type="text" id="playerName" />
    <button onclick="startGame()">Start</button>
  </div>

  <!-- ONLINE LINKS -->
  <script src="https://q5js.org/q5.js"></script>
  <script src="https://p5play.org/v3/planck.min.js"></script>
  <script src="https://p5play.org/v3/p5play.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      remove
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzuQfWx6Ki0JAabhMEOqlGt0WkUWvvHiw",
      authDomain: "tagg-aead9.firebaseapp.com",
      projectId: "tagg-aead9",
      storageBucket: "tagg-aead9.firebasestorage.app",
      messagingSenderId: "690422245181",
      appId: "1:690422245181:web:4ad03010536705bdf80754"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const playersRef = ref(db, 'players');

    const playerId = `player-${Math.random().toString(36).substr(2, 9)}`;
    const myColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

    let playerName = "";
    let myPlayer;
    let players = {};
    let q;

    // Start game after name is entered
    window.startGame = async () => {
      playerName = document.getElementById('playerName').value.trim() || "Anonymous";
      document.getElementById('namePrompt').style.display = 'none';

      q = await Q5.WebGPU();
      new Canvas(1200, 800);
      world.gravity.y = 0;

      myPlayer = new Sprite();
      myPlayer.diameter = 30;
      myPlayer.color = myColor;
      myPlayer.friction = 0.1;
      myPlayer.drag = 0.1;
      myPlayer.x = random(0 - width / 2, width / 2);
      myPlayer.y = random(0 - height / 2, height / 2);

      // Game loop
      const force = 3;
      q.update = () => {
        background('skyblue');

        if (kb.pressing('up')) myPlayer.applyForce(0, -force);
        if (kb.pressing('down')) myPlayer.applyForce(0, force);
        if (kb.pressing('left')) myPlayer.applyForce(-force, 0);
        if (kb.pressing('right')) myPlayer.applyForce(force, 0);
        let halfWidth = width / 2;
        let halfHeight = height / 2;

        // Bounce off left/right edges
        if (myPlayer.x - myPlayer.diameter / 2 <= -halfWidth || myPlayer.x + myPlayer.diameter / 2 >= halfWidth) {
          myPlayer.vel.x *= -0.75;
          myPlayer.x = constrain(myPlayer.x, -halfWidth + myPlayer.diameter / 2, halfWidth - myPlayer.diameter / 2);
        }

        // Bounce off top/bottom edges
        if (myPlayer.y - myPlayer.diameter / 2 <= -halfHeight || myPlayer.y + myPlayer.diameter / 2 >= halfHeight) {
          myPlayer.vel.y *= -0.75;
          myPlayer.y = constrain(myPlayer.y, -halfHeight + myPlayer.diameter / 2, halfHeight - myPlayer.diameter / 2);
        }


        syncMyPlayer();

        // Draw other players' names
        for (let id in players) {
          for (let id in players) {
            let p = players[id];
            textAlign(CENTER);
            textSize(14);
            fill('black');
            text(p.playerName, p.x, p.y - 25); // Show name above sprite
          }
        }

        // Draw my name
        textAlign(CENTER);
        textSize(14);
        fill('black');
        text(playerName, myPlayer.x, myPlayer.y - 25);

      };

      // Handle disconnect
      window.addEventListener('beforeunload', () => {
        remove(ref(db, `players/${playerId}`));
      });

      // Listen for other players
      onValue(playersRef, snapshot => {
        const data = snapshot.val() || {};
        for (let id in data) {
          if (id === playerId) continue;

          if (!players[id]) {
            players[id] = new Sprite();
            players[id].diameter = 30;
            players[id].friction = 0.1;
            players[id].drag = 0.1;
          }

          players[id].x = data[id].x;
          players[id].y = data[id].y;
          players[id].color = data[id].color || 'blue';
          players[id].playerName = data[id].name || "Player"; // Add this line

        }
      });
    };

    function syncMyPlayer() {
      if (!myPlayer) return;
      set(ref(db, `players/${playerId}`), {
        x: myPlayer.x,
        y: myPlayer.y,
        color: myColor,
        name: playerName
      });
    }
  </script>
</body>

</html>